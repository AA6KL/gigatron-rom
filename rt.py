import asm

asm.defun('@start')
asm.ldi('vPC')
asm.stw('pvpc')
asm.ldwi('@ldloc')
asm.stw('ldloc')
asm.ldwi('@stloc')
asm.stw('stloc')
asm.ldwi('@thunk0')
asm.stw('thunk0')
asm.ldwi('@thunk1')
asm.stw('thunk1')
asm.ldwi('@enter')
asm.stw('enter')
asm.ldwi('@leave')
asm.stw('leave')
asm.ldwi('_main')
asm.call('vAC')
asm.label('halt')
asm.ldwi('halt')
asm.jr()

asm.defun('@ldloc')
asm.addw('sp')
asm.deek()
asm.ret()

asm.defun('@stloc')
asm.addw('sp')
asm.stw('ht')
asm.ldw('ha')
asm.doke('ht')
asm.ret()

asm.defun('@thunk0')
asm.stw('ht')
asm.inc('vLRH')
asm.ldi(0)
asm.st('vLR')
asm.ldw('ht')
asm.ret()

asm.defun('@thunk1')
asm.stw('ht')
asm.inc('vLRH')
asm.ldi(0xa0)
asm.st('vLR')
asm.ldw('ht')
asm.ret()

# vAC = bitmask of registers to save. The highest-order bit represents r15.
asm.defun('@enter')
asm.stw('ha')
asm.ldi('r1')
asm.stw('ht')
asm.ldw('ha')
asm.label('loop')
asm.jeq('done')
asm.jgt('next')
asm.ldw('sp')
asm.subi(2)
asm.stw('sp')
asm.ldw('ht')
asm.deek()
asm.doke('sp')
asm.label('next')
asm.inc('ht')
asm.ldw('ha')
asm.addw('ha')
asm.stw('ha')
asm.ldwi('loop')
asm.jr()
asm.label('done')
asm.ret()

# vAC = bitmask of registers to restore. The highest-order bit represents r1.
asm.defun('@leave')
asm.stw('ha')
asm.ldi('r15')
asm.stw('ht')
asm.ldw('ha')
asm.label('loop')
asm.jeq('done')
asm.jgt('next')
asm.ldw('sp')
asm.deek()
asm.doke('ht')
asm.ldw('sp')
asm.addi(2)
asm.stw('sp')
asm.label('next')
asm.ldw('ht')
asm.subi(1)
asm.stw('ht')
asm.ldw('ha')
asm.addw('ha')
asm.stw('ha')
asm.ldwi('loop')
asm.jr()
asm.label('done')
asm.ret()
